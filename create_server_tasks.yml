- name: Create Server
  include_role:
    name: deploy
    tasks_from: create_server
  vars:
    networks_uuids: "{{ Networks | map(attribute='ID') | map('regex_replace', '^(.*)$', '{uuid: \\1}') | map('from_yaml') }}"

- name: Ensure VM is active before proceeding
  include_role:
    name: deploy
    tasks_from: ensure_vm_active
  vars:
    vm_id: "{{ _vm_id }}"

- name: Extruct server info
  include_role:
    name: deploy
    tasks_from: extract_server_info
  vars:
    vm_id: "{{ _vm_id }}"
    network_name: "{{ Networks | map(attribute='NAME') | first }}"

- name: Append role vars
  include_role:
    name: deploy
    tasks_from: append_role_vars
  vars:
    vm_name: "{{ _vm_name }}"
    vm_ip: "{{ _vm_ip }}"

- name: Append host vars
  include_role:
    name: deploy
    tasks_from: append_host_vars
  vars:
    host_vars_file: "{{ Host_vars_dir }}/{{ Vm_name }}.yml"
    vm_name: "{{ _vm_name }}"
    vm_id: "{{ _vm_id }}"
    vm_ip: "{{ _vm_ip }}"

- name: Append inventory hosts
  include_role:
    name: deploy
    tasks_from: append_inventory

- name: Append ssh config
  block:
  - include_vars:
      file: "{{ Role_vars_file }}"
  - include_role:
      name: ssh
      tasks_from: create_ssh_config
